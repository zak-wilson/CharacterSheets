<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="./main-stat.html">
<link rel="import" href="./skill-control.html">

<dom-module id="stat-control">
	<template>
		<style>
			:host {
				display: flex;
				flex: 1 0 25%;
				margin: 5px;
				justify-content: center;
			}

			h2 {
				margin: 0;
			}

			label {
				font-size: 12px;
			}

			.flexColumn {
				display: flex;
				flex-direction: column;
			}

			.flex {
				display: flex;
			}
		</style>

		<main-stat modifier="{{modifier}}" value="{{value}}"></main-stat>
		<div class="flexColumn">
			<h2>[[stat]]</h2>
			<skill-control name="Ability Modifier" modifier="[[modifier]]" required></skill-control>
			<template is="dom-if" if="[[savingThrow]]" restamp>
				<skill-control name="Saving Throw" proficiency-bonus="[[proficiencyBonus]]" modifier="[[modifier]]" required></skill-control>
			</template>
			<template is="dom-repeat" items="[[skills]]">
				<skill-control name="[[item]]" checked$="[[_isChecked(selectedSkills, item)]]" proficiency-bonus="[[proficiencyBonus]]"
				 modifier="[[modifier]]" on-checked-changed="_selectSkills"></skill-control>
			</template>
		</div>
	</template>

	<script>
		Polymer.setPassiveTouchGestures(true);

		class StatControl extends Polymer.Element {
			static get is() { return 'stat-control'; }

			static get properties() {
				return {
					stat: String,
					value: {
						type: Number,
						value: 0,
						notify: true
					},
					modifier: {
						type: Number,
						notify: true
					},
					proficiencyBonus: Number,
					savingThrow: {
						type: Boolean,
						value: false,
						reflectToAttribute: true
					},
					skills: Array,
					selectedSkills: {
						type: Array,
						notify: true
					}
				};
			}

			_isChecked(skills, skill) {
				return (skills || []).includes(skill);
			}

			_selectSkills(e) {
				let skills = JSON.parse(JSON.stringify(this.selectedSkills || []));
				let skillIndex = skills.indexOf(e.target.name);
				if (e.detail.value) {
					if (skillIndex < 0) skills.push(e.target.name);
				} else {
					if (skillIndex >= 0) skills.splice(skillIndex, 1);
				}
				this.selectedSkills = skills;
			}
		}

		window.customElements.define(StatControl.is, StatControl);
	</script>
</dom-module>