<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../components/card-wrapper.html">
<link rel="import" href="../components/spell-card-control.html">

<dom-module id="feats-page">
	<template>
		<style>
			.subcard {
				word-wrap: break-word;

				--title-style: {
					font-size: 18px;
					margin: 8px 0 5px 0;
				}
			}
		</style>
		<div>
			<paper-dropdown label="Feat" value="{{_selectedFeatValue}}" searchable="true">
				<template is="dom-repeat" items="[[_getAvailableFeats(feats, selectedFeats)]]">
					<paper-item value$="[[item.name]]">[[item.displayName]]</paper-item>
				</template>
			</paper-dropdown>
			<paper-icon-button icon="add" title="Add Feat" on-tap="_addFeat"></paper-icon-button>
		</div>

		<template is="dom-repeat" items="[[_getDisplayableFeats(feats, selectedFeats)]]">
			<card-wrapper class="subcard" title="[[item.displayName]]">
				<paper-button data-item$="[[item]]" on-tap="_removeItem" slot="actionIcon">
					<iron-icon data-item$="[[item]]" icon="clear"></iron-icon>Remove
				</paper-button>
				<display-description description="[[item.description]]"></display-description>
			</card-wrapper>
		</template>
	</template>

	<script>
		Polymer.setPassiveTouchGestures(true);

		class FeatsPage extends Polymer.Element {
			static get is() { return 'feats-page'; }

			static get properties() {
				return {
					feats: Object,
					selectedFeats: {
						type: Array,
						value: [],
						notify: true
					},
					_selectedFeatValue: Object
				};
			}

			_addFeat() {
				if (!this._selectedFeatValue) return;

				this.selectedFeats = this.selectedFeats.concat(this._selectedFeatValue);
				this._selectedFeatValue = null;
			}

			_getAvailableFeats(feats, selectedFeats) {
				let featsToReview = Object.keys(feats || {}).map((feat) => feats[feat]);
				let featsSelected = (selectedFeats || []);

				let featsToShow = featsToReview.filter(feat => !featsSelected.includes(feat.name));
				return featsToShow;
			}

			_getDisplayableFeats(feats, selectedFeats) {
				return selectedFeats.map(feat => feats[feat]);
			}

			_removeItem(e) {
				let featToRemove = JSON.parse(e.target.dataset.item);
				let index = this.selectedFeats.findIndex(feat => feat === featToRemove.name);
				this.selectedFeats.splice(index, 1);
				this.selectedFeats = JSON.parse(JSON.stringify(this.selectedFeats));
			}
		}

		window.customElements.define(FeatsPage.is, FeatsPage);
	</script>
</dom-module>