<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../components/card-wrapper.html">
<link rel="import" href="../components/proficiency-control.html">
<link rel="import" href="../components/stat-control.html">

<dom-module id="character-sheet-creator">
	<template>
		<style>
			:host {
				display: block;
			}

			.strength {
				--main-stat-colour: red;
			}

			.dexterity {
				--main-stat-colour: green;
			}

			.constitution {
				--main-stat-colour: orange;
			}

			.intelligence {
				--main-stat-colour: blue;
			}

			.wisdom {
				--main-stat-colour: yellow;
			}

			.charisma {
				--main-stat-colour: purple;
			}

			.flexInline {
				display: flex;
				flex-wrap: wrap;
				justify-content: space-around;
			}
		</style>

		<card-wrapper title="Basic Info" opened>
			<div class="flexInline">
				<paper-input required label="Name"></paper-input>
				<paper-dropdown-menu label="Class" value="{{_selectedClassValue}}">
					<paper-listbox slot="dropdown-content">
						<template is="dom-repeat" items="{{_classes}}">
							<paper-item>[[item]]</paper-item>
						</template>
					</paper-listbox>
				</paper-dropdown-menu>
				<paper-dropdown-menu label="Race" value="{{_selectedRaceValue}}">
					<paper-listbox slot="dropdown-content">
						<template is="dom-repeat" items="{{_getObjectKeys(_races)}}">
							<paper-item>[[item]]</paper-item>
						</template>
					</paper-listbox>
				</paper-dropdown-menu>
				<template is="dom-if" if="[[_subraces]]" restamp>
					<paper-dropdown-menu label="Subrace" value="{{_selectedSubraceValue}}">
						<paper-listbox slot="dropdown-content">
							<template is="dom-repeat" items="{{_subraces}}">
								<paper-item>[[item]]</paper-item>
							</template>
						</paper-listbox>
					</paper-dropdown-menu>
				</template>
			</div>
		</card-wrapper>
		<card-wrapper title="Stats">
			<div class="flexInline">
				<stat-control class="strength" stat="Strength"></stat-control>
				<stat-control class="dexterity" stat="Dexterity"></stat-control>
				<stat-control class="constitution" stat="Constitution"></stat-control>
				<stat-control class="intelligence" stat="Intelligence"></stat-control>
				<stat-control class="wisdom" stat="Wisdom"></stat-control>
				<stat-control class="charisma" stat="Charisma"></stat-control>
			</div>
		</card-wrapper>
		<card-wrapper title="Proficencies">
			<proficiency-control type="Weapon" race="[[_selectedRace]]" subrace="[[_selectedSubrace]]" selected-class="[[_selectedClass]]"></proficiency-control>
			<proficiency-control type="Armour" race="[[_selectedRace]]" subrace="[[_selectedSubrace]]" selected-class="[[_selectedClass]]"></proficiency-control>
			<proficiency-control type="Tool" race="[[_selectedRace]]" subrace="[[_selectedSubrace]]" selected-class="[[_selectedClass]]"></proficiency-control>
			<proficiency-control type="Language" race="[[_selectedRace]]" subrace="[[_selectedSubrace]]" selected-class="[[_selectedClass]]"></proficiency-control>
		</card-wrapper>
		<card-wrapper title="Spells">

		</card-wrapper>
		<card-wrapper title="Items">

		</card-wrapper>
		<card-wrapper title="Equipment">

		</card-wrapper>
	</template>

	<script>
		Polymer.setPassiveTouchGestures(true);

		class CharacterSheetCreator extends Polymer.Element {
			static get is() { return 'character-sheet-creator'; }

			static get properties() {
				return {
					title: {
						type: String,
						value: "Character Sheet Creator"
					},
					_races: Object,
					_subraces: Array,
					_selectedRace: Object,
					_selectedRaceValue: {
						type: String,
						observer: '_selectedRaceChanged'
					},
					_selectedSubrace: Object,
					_selectedSubraceValue: {
						type: String,
						observer: '_selectedSubraceChanged'
					},
					_classes: Array,
					_selectedClass: Object,
					_selectedClassValue: {
						type: String,
						observer: '_selectedClassChanged'
					}
				};
			}

			constructor() {
				super();
				this._fileLoader('src/data/races.json', function (data) { this._races = data; });
				this._fileLoader('src/data/classes.json', function (data) { this._classes = data; });
			}

			_selectedRaceChanged(race) {
				if (!race) return;

				this._subraces = this._races[race].Subraces || null;
				this._selectedSubraceValue = null;
				this._fileLoader('src/data/races/' + race + '.json', function (data) { this._selectedRace = data });
			}
			_selectedSubraceChanged(subrace) {
				if (!subrace) return;

				this._fileLoader('src/data/races/' + this._selectedRaceValue + '/' + subrace + '.json', function (data) { this._selectedSubrace = data });
			}
			_selectedClassChanged(selectedClass) {
				this._fileLoader('src/data/classes/' + selectedClass + '.json', function (data) { this._selectedClass = data });
			}

			_getObjectKeys(obj) {
				return Object.keys(obj || {});
			}
			_fileLoader(file, propToSet) {
				fetch(file).then(function (data) { return data.json() }.bind(this)).then(propToSet.bind(this));
			}
		}

		window.customElements.define(CharacterSheetCreator.is, CharacterSheetCreator);
	</script>
</dom-module>