<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../components/card-wrapper.html">
<link rel="import" href="../components/proficiency-control.html">
<link rel="import" href="../components/stat-control.html">

<dom-module id="character-sheet-creator">
	<template>
		<style>
			:host {
				display: block;
			}

			.strength {
				--main-stat-colour: red;
			}

			.dexterity {
				--main-stat-colour: green;
			}

			.constitution {
				--main-stat-colour: orange;
			}

			.intelligence {
				--main-stat-colour: blue;
			}

			.wisdom {
				--main-stat-colour: yellow;
			}

			.charisma {
				--main-stat-colour: purple;
			}

			.flexInline {
				display: flex;
				flex-wrap: wrap;
				justify-content: space-around;
			}
		</style>

		<card-wrapper title="Basic Info" opened>
			<div class="flexInline">
				<paper-input required label="Name"></paper-input>
				<paper-dropdown-menu label="Class" value="{{_selectedClassValue}}">
					<paper-listbox slot="dropdown-content">
						<template is="dom-repeat" items="{{_classes}}">
							<paper-item>[[item]]</paper-item>
						</template>
					</paper-listbox>
				</paper-dropdown-menu>
				<paper-dropdown-menu label="Race" value="{{_selectedRaceValue}}">
					<paper-listbox slot="dropdown-content">
						<template is="dom-repeat" items="{{_getObjectKeys(_races)}}">
							<paper-item>[[item]]</paper-item>
						</template>
					</paper-listbox>
				</paper-dropdown-menu>
				<template is="dom-if" if="[[_subraces]]" restamp>
					<paper-dropdown-menu label="Subrace" value="{{_selectedSubraceValue}}">
						<paper-listbox slot="dropdown-content">
							<template is="dom-repeat" items="{{_subraces}}">
								<paper-item>[[item]]</paper-item>
							</template>
						</paper-listbox>
					</paper-dropdown-menu>
				</template>
			</div>
		</card-wrapper>
		<card-wrapper title="Stats">
			<div class="flexInline">
				<stat-control class="strength" stat="Strength" static-skills="[[_staticSkills]]" proficiency-bonus="[[_selectedClass.ProficiencyBonus]]" selectable-skills="[[_selectedClass.Skills]]" selected-skills="{{_selectedSkills}}" skills="[[_strengthSkills]]" saving-throw$="[[_collectionContains(_selectedClass.SavingThrows, 'Strength')]]" bonus="[[_getStatBonus(_selectedRace.AbilityScoreBonus.Strength, _selectedSubrace.AbilityScoreBonus.Strength, _selectedClass.AbilityScoreBonus.Strength)]]"></stat-control>
				<stat-control class="dexterity" stat="Dexterity" static-skills="[[_staticSkills]]" proficiency-bonus="[[_selectedClass.ProficiencyBonus]]" selectable-skills="[[_selectedClass.Skills]]" selected-skills="{{_selectedSkills}}" skills="[[_dexteritySkills]]" saving-throw$="[[_collectionContains(_selectedClass.SavingThrows, 'Dexterity')]]" bonus="[[_getStatBonus(_selectedRace.AbilityScoreBonus.Dexterity, _selectedSubrace.AbilityScoreBonus.Dexterity, _selectedClass.AbilityScoreBonus.Dexterity)]]"></stat-control>
				<stat-control class="constitution" stat="Constitution" static-skills="[[_staticSkills]]" proficiency-bonus="[[_selectedClass.ProficiencyBonus]]" selectable-skills="[[_selectedClass.Skills]]" selected-skills="{{_selectedSkills}}" skills="[[_constitutionSkills]]" saving-throw$="[[_collectionContains(_selectedClass.SavingThrows, 'Constitution')]]" bonus="[[_getStatBonus(_selectedRace.AbilityScoreBonus.Constitution, _selectedSubrace.AbilityScoreBonus.Constitution, _selectedClass.AbilityScoreBonus.Constitution)]]"></stat-control>
				<stat-control class="intelligence" stat="Intelligence" static-skills="[[_staticSkills]]" proficiency-bonus="[[_selectedClass.ProficiencyBonus]]" selectable-skills="[[_selectedClass.Skills]]" selected-skills="{{_selectedSkills}}" skills="[[_intelligenceSkills]]" saving-throw$="[[_collectionContains(_selectedClass.SavingThrows, 'Intelligence')]]" bonus="[[_getStatBonus(_selectedRace.AbilityScoreBonus.Intelligence, _selectedSubrace.AbilityScoreBonus.Intelligence, _selectedClass.AbilityScoreBonus.Intelligence)]]"></stat-control>
				<stat-control class="wisdom" stat="Wisdom" static-skills="[[_staticSkills]]" proficiency-bonus="[[_selectedClass.ProficiencyBonus]]" selectable-skills="[[_selectedClass.Skills]]" selected-skills="{{_selectedSkills}}" skills="[[_wisdomSkills]]" saving-throw$="[[_collectionContains(_selectedClass.SavingThrows, 'Wisdom')]]" bonus="[[_getStatBonus(_selectedRace.AbilityScoreBonus.Wisdom, _selectedSubrace.AbilityScoreBonus.Wisdom, _selectedClass.AbilityScoreBonus.Wisdom)]]"></stat-control>
				<stat-control class="charisma" stat="Charisma" static-skills="[[_staticSkills]]" proficiency-bonus="[[_selectedClass.ProficiencyBonus]]" selectable-skills="[[_selectedClass.Skills]]" selected-skills="{{_selectedSkills}}" skills="[[_charismaSkills]]" saving-throw$="[[_collectionContains(_selectedClass.SavingThrows, 'Charisma')]]" bonus="[[_getStatBonus(_selectedRace.AbilityScoreBonus.Charisma, _selectedSubrace.AbilityScoreBonus.Charisma, _selectedClass.AbilityScoreBonus.Charisma)]]"></stat-control>
			</div>
		</card-wrapper>
		<card-wrapper title="Proficiencies">
			<proficiency-control type="Weapon" race="[[_selectedRace.Proficiencies.Weapon]]" subrace="[[_selectedSubrace.Proficiencies.Weapon]]" selected-class="[[_selectedClass.Proficiencies.Weapon]]"></proficiency-control>
			<proficiency-control type="Armour" race="[[_selectedRace.Proficiencies.Armour]]" subrace="[[_selectedSubrace.Proficiencies.Armour]]" selected-class="[[_selectedClass.Proficiencies.Armour]]"></proficiency-control>
			<proficiency-control type="Tool" race="[[_selectedRace.Proficiencies.Tool]]" subrace="[[_selectedSubrace.Proficiencies.Tool]]" selected-class="[[_selectedClass.Proficiencies.Tool]]"></proficiency-control>
			<proficiency-control type="Language" race="[[_selectedRace.Proficiencies.Language]]" subrace="[[_selectedSubrace.Proficiencies.Language]]" selected-class="[[_selectedClass.Proficiencies.Language]]"></proficiency-control>
		</card-wrapper>
		<card-wrapper title="Spells">

		</card-wrapper>
		<card-wrapper title="Items">

		</card-wrapper>
		<card-wrapper title="Equipment">

		</card-wrapper>
	</template>

	<script>
		Polymer.setPassiveTouchGestures(true);

		class CharacterSheetCreator extends Polymer.Element {
			static get is() { return 'character-sheet-creator'; }

			static get properties() {
				return {
					title: {
						type: String,
						value: "Character Sheet Creator"
					},
					_races: Object,
					_subraces: Array,
					_selectedRace: Object,
					_selectedRaceValue: {
						type: String,
						observer: '_selectedRaceChanged'
					},
					_selectedSubrace: Object,
					_selectedSubraceValue: {
						type: String,
						observer: '_selectedSubraceChanged'
					},
					_classes: Array,
					_selectedClass: Object,
					_selectedClassValue: {
						type: String,
						observer: '_selectedClassChanged'
					},
					_selectedSkills: {
						type: Array,
						value: []
					},
					_staticSkills: {
						type: Array,
						value: [],
						computed: '_collectionCombiner(_selectedRace.Skills, _selectedSubrace.Skills)'
					},
					_strengthSkills: {
						type: Array,
						value: [
							"Athletics"
						]
					},
					_dexteritySkills: {
						type: Array,
						value: [
							"Acrobatics",
							"Sleight of Hand",
							"Stealth"
						]
					},
					_constitutionSkills: {
						type: Array,
						value: []
					},
					_intelligenceSkills: {
						type: Array,
						value: [
							"Arcana",
							"History",
							"Investigation",
							"Nature",
							"Religion"
						]
					},
					_wisdomSkills: {
						type: Array,
						value: [
							"Animal Handling",
							"Insight",
							"Medicine",
							"Perception",
							"Survival"
						]
					},
					_charismaSkills: {
						type: Array,
						value: [
							"Deception",
							"Intimidation",
							"Performance",
							"Persuasion"
						]
					}
				};
			}

			constructor() {
				super();
				this._fileLoader('src/data/races.json', (data) => this._races = data);
				this._fileLoader('src/data/classes.json', (data) => this._classes = data);
			}

			_selectedRaceChanged(race) {
				this._selectedSubraceValue = null;
				if (!race) {
					this._selectedRace = null;
					return;
				}

				this._subraces = this._races[race].Subraces || null;
				this._fileLoader('src/data/races/' + race + '.json', (data) => this._selectedRace = data);
			}
			_selectedSubraceChanged(subrace) {
				if (!subrace) {
					this._selectedSubrace = null;
					return;
				}

				this._fileLoader('src/data/races/' + this._selectedRaceValue + '/' + subrace + '.json', (data) => this._selectedSubrace = data);
			}
			_selectedClassChanged(selectedClass) {
				if (!selectedClass) {
					this._selectedClass = null;
					return;
				}

				this._fileLoader('src/data/classes/' + selectedClass + '.json', (data) => this._selectedClass = data);
			}

			_getStatBonus(race, subrace, selectedClass) {
				return race || 0 + subrace || 0 + selectedClass || 0;
			}

			_collectionCombiner(collection, collection2){
				return (collection || []).concat(collection2 || []);
			}
			_collectionContains(collection, value) {
				return (collection || []).includes(value);
			}
			_getObjectKeys(obj) {
				return Object.keys(obj || {});
			}
			_fileLoader(file, propToSet) {
				fetch(file).then((data) => data.json()).then(propToSet.bind(this));
			}
		}

		window.customElements.define(CharacterSheetCreator.is, CharacterSheetCreator);
	</script>
</dom-module>