<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../components/card-wrapper.html">
<link rel="import" href="../components/proficiency-control.html">
<link rel="import" href="../components/display-description.html">
<link rel="import" href="./spells-page.html">
<link rel="import" href="./feats-page.html">
<link rel="import" href="./stat-page.html">

<dom-module id="character-sheet-creator">
	<template>
		<style>
			:host {
				display: block;
			}

			.flexInline {
				display: flex;
				flex-wrap: wrap;
				justify-content: space-around;
			}

			.flexSpaceBetween {
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.subcard {
				word-wrap: break-word;
				--title-style: {
					font-size: 18px;
					margin: 8px 0 5px 0;
				}
			}

			.smallText {
				width: 35px;
				text-align: center;
			}

			.marginLeft {
				margin-left: 15px;
			}

			.inputLookNotDisabled {
				--paper-input-container-disabled: {
					opacity: 1;
				}
			}

			paper-fab {
				/* visibility: hidden; */
				--paper-fab-background: #4285f4;
			}
		</style>

		<iron-ajax id="getCharacters" auto url="http://localhost:44443/" on-response="_characterResponse"></iron-ajax>
		<iron-ajax id="getCharacter" auto url="http://localhost:44443/[[_encodeName(_selectedCharacter)]]" on-response="_characterResponse"></iron-ajax>
		<iron-ajax id="saveCharacter" url="http://localhost:44443/" body="[[_stringify(_character)]]" content-type="application/json"
		 method="POST" on-response="_characterResponse"></iron-ajax>

		<card-wrapper title="Basic Info" opened>
			<div class="flexInline">
				<div class="flexSpaceBetween">
					<paper-dropdown label="Load Character" value="{{_selectedCharacter}}">
						<template is="dom-repeat" items="[[_characters]]">
							<paper-item>[[item]]</paper-item>
						</template>
					</paper-dropdown>
					<template is="dom-if" if="[[_canLevelUp(_level)]]">
						<paper-icon-button icon="save" on-tap="_save"></paper-icon-button>
					</template>
				</div>
				<paper-input label="Name" value="{{_name}}"></paper-input>
				<div class="flexSpaceBetween">
					<paper-dropdown label="Class" value="{{_selectedClassValue}}">
						<template is="dom-repeat" items="{{_classes}}">
							<paper-item>[[item]]</paper-item>
						</template>
					</paper-dropdown>
					<paper-input class="smallText marginLeft inputLookNotDisabled" disabled label="Level" value="{{_level}}"></paper-input>
					<template is="dom-if" if="[[_canLevelUp(_level)]]">
						<paper-icon-button icon="arrow-upward" on-tap="_levelUp"></paper-icon-button>
					</template>
				</div>
				<paper-dropdown label="Background" value="{{_selectedBackgroundValue}}">
					<template is="dom-repeat" items="{{_backgrounds}}">
						<paper-item>[[item]]</paper-item>
					</template>
				</paper-dropdown>
				<paper-dropdown label="Race" value="{{_selectedRaceValue}}">
					<template is="dom-repeat" items="{{_getObjectKeys(_races)}}">
						<paper-item>[[item]]</paper-item>
					</template>
				</paper-dropdown>
				<template is="dom-if" if="[[_subraces]]" restamp>
					<paper-dropdown label="Subrace" value="{{_selectedSubraceValue}}">
						<template is="dom-repeat" items="{{_subraces}}">
							<paper-item>[[item]]</paper-item>
						</template>
					</paper-dropdown>
				</template>
			</div>
		</card-wrapper>
		<card-wrapper title="Stats">
			<stat-page strength="{{_stats.strength}}" dexterity="{{_stats.dexterity}}" constitution="{{_stats.constitution}}"
			 intelligence="{{_stats.intelligence}}" wisdom="{{_stats.wisdom}}" charisma="{{_stats.charisma}}" selected-skills="{{_stats.skills}}"
			 current-hit-points="{{_stats.currentHitPoints}}" max-hit-points="{{_stats.maxHitPoints}}" proficiency-bonus="{{_stats.proficiencyBonus}}"
			 armour-class="{{_stats.armourClass}}" initiative="{{_stats.initiative}}" speed="{{_stats.speed}}" saving-throws="[[_savingThrows]]"
			 modifiers="{{_statModifiers}}" loading-file="[[_loadingFile]]"></stat-page>
		</card-wrapper>
		<card-wrapper title="Proficiencies">
			<proficiency-control type="Weapon" value="{{_proficiencies.weapon}}"></proficiency-control>
			<proficiency-control type="Armour" value="{{_proficiencies.armour}}"></proficiency-control>
			<proficiency-control type="Tool" value="{{_proficiencies.tool}}"></proficiency-control>
			<proficiency-control type="Language" value="{{_proficiencies.language}}"></proficiency-control>
		</card-wrapper>
		<card-wrapper title="Spells">
			<spells-page spells="[[_spells]]" class-name="[[_selectedClass.name]]" spell-save-difficulty-class="[[_spellSaveDifficultyClass]]"
			 spell-attack-modifier="[[_spellAttackModifier]]" selected-spells="{{_selectedSpells}}" loading-file="[[_loadingFile]]"></spells-page>
		</card-wrapper>
		<card-wrapper title="Feats">
			<feats-page feats="[[_feats]]" selected-feats="{{_selectedFeats}}"></feats-page>
		</card-wrapper>
		<card-wrapper title="Traits">
			<template is="dom-repeat" items="[[_traitsSelected]]">
				<card-wrapper class="subcard" title="[[item]]">
					<display-description description="[[_getTraitDescription(_traits, item)]]"></display-description>
				</card-wrapper>
			</template>
		</card-wrapper>
		<card-wrapper title="Items">
			<paper-textarea value="{{_items}}"></paper-textarea>
		</card-wrapper>
		<card-wrapper title="Equipment">
			<div class="flexInline">
				<paper-input class="smallText" label="CP" value="{{_cp}}"></paper-input>
				<paper-input class="smallText" label="SP" value="{{_sp}}"></paper-input>
				<paper-input class="smallText" label="EP" value="{{_ep}}"></paper-input>
				<paper-input class="smallText" label="GP" value="{{_gp}}"></paper-input>
				<paper-input class="smallText" label="PP" value="{{_pp}}"></paper-input>
			</div>
			<paper-textarea value="{{_equipment}}"></paper-textarea>
		</card-wrapper>
		<card-wrapper title="Other">
			<paper-textarea value="{{_other}}"></paper-textarea>
		</card-wrapper>
	</template>

	<script>
		Polymer.setPassiveTouchGestures(true);

		class CharacterSheetCreator extends Polymer.Element {
			static get is() { return 'character-sheet-creator'; }

			static get properties() {
				return {
					title: {
						type: String,
						value: "Character Sheet Creator"
					},
					_spells: Object,
					_feats: Array,
					_traits: Object,
					_races: Array,
					_subraces: Array,
					_name: String,
					_level: {
						type: Number,
						value: 1
					},
					_selectedRace: {
						type: Object,
						value: {},
						observer: '_selectedRaceChanged'
					},
					_selectedRaceValue: {
						type: String,
						observer: '_selectedRaceValueChanged'
					},
					_selectedSubrace: {
						type: Object,
						value: {},
						observer: '_selectedSubraceChanged'
					},
					_selectedSubraceValue: {
						type: String,
						observer: '_selectedSubraceValueChanged'
					},
					_classes: Array,
					_selectedClass: {
						type: Object,
						value: {},
						observer: '_selectedClassChanged'
					},
					_selectedClassValue: {
						type: String,
						observer: '_selectedClassValueChanged'
					},
					_backgrounds: Array,
					_selectedBackground: {
						type: Object,
						value: {},
						observer: '_selectedBackgroundChanged'
					},
					_selectedBackgroundValue: {
						type: String,
						observer: '_selectedBackgroundValueChanged'
					},
					_statModifiers: {
						type: Object,
						value: {}
					},
					_inheritValues: {
						type: Boolean,
						value: false
					},
					_characters: {
						type: Array,
						value: []
					},
					_selectedCharacter: String,
					_character: {
						type: Object,
						observer: '_loadedCharacter'
					},
					_stats: {
						type: Object,
						value: {
							strength: 0,
							dexterity: 0,
							constitution: 0,
							intelligence: 0,
							wisdom: 0,
							charisma: 0,
							skills: [],
							currentHitPoints: 0,
							maxHitPoints: 0,
							proficiencyBonus: 0,
							armourClass: 0,
							initiative: 0,
							speed: 0
						}
					},
					_savingThrows: {
						type: Array,
						value: []
					},
					_proficiencies: {
						type: Object,
						value: {}
					},
					_selectedSpells: Array,
					_traitsSelected: Array,
					_spellSaveDifficultyClass: {
						type: Number,
						computed: '_getSpellSaveDifficultyClass(_selectedClass.spellSaveDifficultyClass, _stats.proficiencyBonus, _statModifiers)'
					},
					_spellAttackModifier: {
						type: Number,
						computed: '_getSpellAttackModifier(_selectedClass.spellAttackModifier, _stats.proficiencyBonus, _statModifiers)'
					},
					_spellSaveDifficultyClassString: String,
					_spellAttackModifierString: String,
					_selectedFeats: Array,
					_items: String,
					_cp: String,
					_sp: String,
					_ep: String,
					_gp: String,
					_pp: String,
					_equipment: String,
					_other: String,
					_loadingFile: {
						type: Boolean,
						value: false
					}
				};
			}

			constructor() {
				super();
				this._fileLoader('src/data/races.json', (data) => this._races = data);
				this._fileLoader('src/data/classes.json', (data) => this._classes = data);
				this._fileLoader('src/data/spells.json', (data) => this._spells = data);
				this._fileLoader('src/data/traits.json', (data) => this._traits = data);
				this._fileLoader('src/data/backgrounds.json', (data) => this._backgrounds = data);
				this._fileLoader('src/data/feats.json', (data) => this._feats = data);
			}

			_selectedRaceValueChanged(race) {
				this._selectedSubraceValue = null;
				if (!race) {
					this._selectedRace = null;
					return;
				}

				this._subraces = this._races[race].Subraces || null;
				this._fileLoader('src/data/races/' + race + '.json', (data) => this._selectedRace = data);
			}
			_selectedSubraceValueChanged(subrace) {
				if (!subrace) {
					this._selectedSubrace = null;
					return;
				}

				this._fileLoader('src/data/races/' + this._selectedRaceValue + '/' + subrace + '.json', (data) => this._selectedSubrace = data);
			}
			_selectedClassValueChanged(selectedClass) {
				if (!selectedClass) {
					this._selectedClass = null;
					return;
				}

				this._fileLoader('src/data/classes/' + selectedClass + '.json', (data) => {
					data.name = selectedClass;
					this._selectedClass = data
				});
			}
			_selectedBackgroundValueChanged(selectedBackground) {
				if (!selectedBackground) {
					this._selectedBackground = null;
					return;
				}

				this._fileLoader('src/data/backgrounds/' + selectedBackground + '.json', (data) => this._selectedBackground = data);
			}

			_getStatBonus(race, subrace, selectedClass) {
				return race || 0 + subrace || 0 + selectedClass || 0;
			}

			_getTraitDescription(traits, trait) {
				return (traits[trait] || { description: [trait] }).description;
			}

			_levelUp() {
				this._level = Number(this._level) + 1;
			}
			_canLevelUp(level) {
				return level < 20;
			}

			_selectedRaceChanged(newRace, oldRace) {
				this._updateStats(newRace, oldRace);
			}
			_selectedSubraceChanged(newSubrace, oldSubrace) {
				this._updateStats(newSubrace, oldSubrace);
			}
			_selectedClassChanged(newClass, oldClass) {
				this._updateStats(newClass, oldClass);
			}
			_selectedBackgroundChanged(newBackground, oldBackground) {
				this._updateStats(newBackground, oldBackground);
			}
			_updateStats(newValue, oldValue) {
				this._savingThrows = this._switchArrayValues(this._savingThrows || [], newValue && newValue.savingThrows || [], oldValue && oldValue.savingThrows || []);
				this._traitsSelected = this._switchArrayValues(this._traitsSelected || [], newValue && newValue.traits || [], oldValue && oldValue.traits || []);
			}

			_getSpellAttackModifier(spellAttackModifierString, proficiencyBonus, statModifiers) {
				return this._processStatString(spellAttackModifierString, statModifiers, proficiencyBonus);
			}
			_getSpellSaveDifficultyClass(spellSaveDifficultyClassString, proficiencyBonus, statModifiers) {
				return this._processStatString(spellSaveDifficultyClassString, statModifiers, proficiencyBonus);
			}
			_processStatString(value, statModifiers, proficiencyBonus, level) {
				if (!value) return 0;
				if (typeof (value) === 'number') return value;

				let minimum = null;
				let stringVal = value;
				if (value.value) {
					stringVal = value.value;
					minimum = value.minimum;
				}

				let pieces = stringVal.split(' + ');
				let ret = pieces.map(piece => {
					if (Number(piece)) return Number(piece);
					if (piece === 'proficiencyBonus') return Number(proficiencyBonus);
					if (piece === 'level') return Number(level);
					if (statModifiers[piece]) return Number(statModifiers[piece]);
					return 0;
				}).reduce(this._sum, 0);

				if (minimum !== null && ret < minimum) return minimum;

				return ret;
			}

			_save() {
				this._character = {
					name: this._name,
					class: this._selectedClassValue,
					level: this._level,
					background: this._selectedBackgroundValue,
					race: this._selectedRaceValue,
					subrace: this._selectedSubraceValue,
					stats: this._stats,
					proficiencies: this._proficiencies,
					spells: this._selectedSpells,
					feats: this._selectedFeats,
					item: this._items,
					equipment: this._equipment,
					cp: this._cp,
					sp: this._sp,
					ep: this._ep,
					gp: this._gp,
					pp: this._pp,
					other: this._other
				};
				this.$.saveCharacter.generateRequest();
			}

			_encodeName(name) {
				return encodeURI(name);
			}

			_characterResponse(e) {
				if (!e.target.lastResponse) return;

				switch (e.target.id) {
					case 'getCharacters':
						this._characters = e.target.lastResponse;
						break;
					case 'getCharacter':
						this._character = e.target.lastResponse;
						break;
					case 'saveCharacter':
						this.$.getCharacters.generateRequest();
						break;
				}
			}

			_loadedCharacter(result) {
				this._loadingFile = true;
				this._name = result.name;
				this._selectedClassValue = result.class;
				this._level = result.level;
				this._selectedBackgroundValue = result.background;
				this._selectedRaceValue = result.race;
				this._selectedSubraceValue = result.subrace;
				this._stats = result.stats;
				this._proficiencies = result.proficiencies;
				this._selectedSpells = result.spells;
				this._selectedFeats = result.feats;
				this._items = result.item;
				this._equipment = result.equipment;
				this._cp = result.cp;
				this._sp = result.sp;
				this._ep = result.ep;
				this._gp = result.gp;
				this._pp = result.pp;
				this._other = result.other;
				this._loadingFile = false;
			}


			_switchArrayValues(values, newValue, oldValue) {
				if (oldValue && Array.isArray(oldValue)) {
					for (let value of oldValue) {
						let i = values.indexOf(value);
						if (i >= 0) values.splice(i, 1);
					}
				}
				if (newValue && Array.isArray(newValue))
					values = values.concat(newValue);
				return values;
			}
			_sum(accumulator, value) {
				return accumulator + value;
			}
			_collectionCombiner(collection, collection2) {
				return (collection || []).concat(collection2 || []);
			}
			_collectionContains(collection, value) {
				return (collection || []).includes(value);
			}
			_getObjectKeys(obj) {
				return Object.keys(obj || {});
			}
			_fileLoader(file, propToSet) {
				fetch(file).then((data) => data.json()).then(propToSet.bind(this));
			}
			_stringify(value) { return JSON.stringify(value); }
		}

		window.customElements.define(CharacterSheetCreator.is, CharacterSheetCreator);
	</script>
</dom-module>